#!/usr/bin/env bash
# Summary: a fake `flutter` CLI that delegate the actual flutter CLI.

set -e

if [[ "$1" = "--debug" ]]; then
    export FENV_DEBUG=1
    shift
fi

if [[ -n "$FENV_DEBUG" ]]; then
    # https://wiki-dev.bash-hackers.org/scripting/debuggingtips#making_xtrace_more_useful
    export PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
    set -x
fi

function abort() {
  >&2 echo "fenv: $*"
  exit 2
}

function abort_on_disallowed_command() {
  abort "\`flutter $command\` is not allowed. use \`fenv install/uninstall\` instead"
}

function abort_on_pollution() {
  abort "Flutter SDK in \`$(fenv prefix)\` is polluted: do \`fenv uninstall $specified_version && fenv install $specified_version\`"
}

function find_command() {
  for args in "$@"; do
    if ! echo "$args" | grep '^\-' > /dev/null; then
      echo "$args"
      return
    fi
  done
}

function run_flutter() {
  PATH="$flutter_cli_dir:$PATH" $flutter_cli "$@"
}

function retrieve_flutter_version() {
  local version_file
  version_file="$(fenv prefix)/version"

  if [[ -f "$version_file" ]]; then
    # For Flutter SDK < 3.38: read from version file
    cat "$version_file"
  else
    # For Flutter SDK >= 3.38: extract version from flutter --version output
    local flutter_bin
    flutter_bin="$(fenv prefix)/bin/flutter"
    if ! [[ -f "$flutter_bin" ]]; then
      return 1
    fi

    local version_output
    if ! version_output="$("$flutter_bin" --version 2>/dev/null)"; then
      return 1
    fi

    # Extract version from first line: "Flutter 3.38.5 • channel stable • ..."
    local extracted_version
    extracted_version="$(echo "$version_output" | head -n 1 | sed -E 's/Flutter ([0-9]+\.[0-9]+\.[0-9]+).*/\1/')" || {
      return 1
    }

    # Verify that we extracted a valid version format (x.y.z)
    if ! echo "$extracted_version" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' > /dev/null; then
      return 1
    fi

    echo "$extracted_version"
  fi
}

flutter_cli=$(fenv which flutter)
command="$(find_command "$@")"
specified_version="$(fenv version-name)"
flutter_cli_dir="$(dirname "$flutter_cli")"

case "$specified_version" in
  dev | beta | master | stable )
    case "$command" in
      channel )
        abort_on_disallowed_command
        ;;

      * )
        run_flutter "$@"
        ;;
    esac
    ;;

  * )
    case "$command" in
      upgrade | downgrade | channel )
        abort_on_disallowed_command
        ;;

      * )
        if ! flutter_version="$(retrieve_flutter_version 2>/dev/null)"; then
          abort_on_pollution
        fi
        if [[ -z "$flutter_version" ]]; then
          abort_on_pollution
        fi

        if [[ "$flutter_version" == "$specified_version" ]]; then
          run_flutter "$@"
        else
          abort_on_pollution
        fi
        ;;
    esac
    ;;
esac
